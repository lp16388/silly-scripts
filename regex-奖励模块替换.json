{
    "id": "afb9dace-b9dd-49b0-8d81-7363db5e0d54",
    "scriptName": "奖励模块替换",
    "findRegex": "<\\/?REWARD>",
    "replaceString": "```\n<!doctype html><html lang=\"zh-CN\"><head><meta charset=\"UTF-8\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><title>奖励领取</title><style>:root{--nbg: var(--notebook-bg, #fffaf7);--nborder: var(--notebook-border, #f2e4d5);--t1: var(--text-primary, #6d5b5b);--t2: var(--text-secondary, #b19d9d);--y: var(--bookmark-yellow, #fff9c4)}.reward-page{width:100%;max-width:900px;margin:0 auto;padding:8px;box-sizing:border-box}.reward-page *,.reward-page *::before,.reward-page *::after{box-sizing:border-box}.reward-card{position:relative;width:100%;border:2px solid var(--nborder);border-radius:0;padding:12px;background:var(--nbg);box-shadow:0 8px 24px rgba(0,0,0,.06);display:flex;flex-direction:column}.reward-card::before,.reward-card::after{display:none;content:none;animation:none}.card-wave,.wave-top,.wave-bottom{display:none !important}@keyframes waveSlide{0%{background-position:0 100%}100%{background-position:100% 100%}}.reward-header,.reward-grid,.reward-actions{position:relative;z-index:1}.reward-header{display:flex;align-items:center;gap:10px}.title{font:800 18px \"ZCOOL KuaiLe\",\"Noto Sans SC\",system-ui;color:var(--t1)}.badge{margin-left:auto;padding:4px 10px;border-radius:10px;border:2px solid var(--nborder);background:var(--y);color:var(--t1);font:900 12px \"ZCOOL KuaiLe\",\"Noto Sans SC\"}.reward-grid{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;min-height:0;overflow:visible}.pane{border-radius:0;padding:10px;background:#fff;border:2px dashed #d9c7aa}.pane-change{background:#fffef6;grid-column:1/-1}.pane-exp{background:#f0f8ff;border-color:skyblue;grid-column:1/-1}.pane-card{border-color:#ffc1d6}.pane-artifact{border-color:#b9d6ff}.pane-item{border-color:#bfe7bf}.pane-tag{display:inline-block;padding:2px 10px;border-radius:0;border:2px solid #d9c7aa;background:#fff;color:#6b5b2e;font:800 12px \"ZCOOL KuaiLe\",\"Noto Sans SC\"}.change-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;color:#6b5b2e;font:500 13px \"Noto Sans SC\"}.pill{padding:6px 10px;border-radius:0;background:#fffef6;border:2px dashed #d9c7aa}.exp-display{margin-top:8px;display:flex;flex-direction:column;gap:8px;color:#2c5aa0;font:500 13px \"Noto Sans SC\"}.exp-item{padding:8px 12px;border-radius:0;background:#e6f3ff;border:2px solid skyblue;display:flex;align-items:center;gap:8px}.exp-icon{font-size:16px}.exp-text{flex:1;font-weight:600}.pane-head{display:flex;align-items:center}.pane-title{font:800 14px \"ZCOOL KuaiLe\",\"Noto Sans SC\";color:var(--t1)}.pane-sub{margin-left:auto;color:var(--t2);font:700 12px \"Noto Sans SC\"}.option{margin-top:8px;display:flex;gap:10px;align-items:center;padding:8px;border-radius:0;background:#fffef6;border:2px dashed currentColor;cursor:pointer}.pane-card .option{color:#a66a79;background:#fffef9;border-color:#ffc1d6}.pane-artifact .option{color:#5c6b82;background:#f8fbff;border-color:#b9d6ff}.pane-item .option{color:#5b7a5b;background:#f7fff7;border-color:#bfe7bf}.option .icon{font-size:18px}.option .text{flex:1;min-width:0}.option .name{font:800 13px \"ZCOOL KuaiLe\",\"Noto Sans SC\";color:var(--t1);word-break:break-word}.option .desc{font:700 12px \"Noto Sans SC\";color:var(--t2);word-break:break-word}.reward-actions{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}.btn{padding:8px 12px;border-radius:0;font:800 12px \"ZCOOL KuaiLe\",\"Noto Sans SC\";border:2px solid var(--nborder);background:#fff;color:var(--t1)}.btn-primary{border:0;color:#634d4d;background:linear-gradient(180deg, var(--y), #ffd9e2);box-shadow:0 8px 16px rgba(136,98,98,.12),inset 0 0 0 2px var(--nborder)}@media(max-width: 880px){.reward-grid{grid-template-columns:1fr;gap:10px}}@media(max-width: 520px){.reward-page{width:calc(100% - 12px);margin:8px auto}.pane{padding:8px}.option{padding:10px;gap:12px}.option .name{font-size:14px}.option .desc{font-size:12px}}\n</style></head><body><div class=\"reward-page\"><div class=\"reward-card\" id=\"reward-card\" style=\"display:none\"><div class=\"reward-header\"><strong class=\"title\">奖励结算</strong> <span class=\"badge\" id=\"level-exp-badge\" style=\"display:none\"></span></div><div class=\"reward-grid\"><section class=\"pane pane-change\" id=\"changes-section\" style=\"display:none\"><span class=\"pane-tag\">本次变化</span><div class=\"change-list\" id=\"changes-list\"></div></section><section class=\"pane pane-exp\" id=\"exp-section\" style=\"display:none\"><span class=\"pane-tag\">等级与经验</span><div class=\"exp-display\" id=\"exp-display\"></div></section><section class=\"pane pane-card\" id=\"card-rewards-section\" style=\"display:none\"><div class=\"pane-head\"><div class=\"pane-title\">可选：卡牌 <span id=\"card-selection-count\">3选1</span></div><div class=\"pane-sub\">已选 <span id=\"card-selected\">0</span>/<span id=\"card-max\">1</span></div></div><div class=\"options\" id=\"card-options\"></div></section><section class=\"pane pane-artifact\" id=\"artifact-rewards-section\" style=\"display:none\"><div class=\"pane-head\"><div class=\"pane-title\">可选：遗物 <span id=\"artifact-selection-count\">3选1</span></div><div class=\"pane-sub\">已选 <span id=\"artifact-selected\">0</span>/<span id=\"artifact-max\">1</span></div></div><div class=\"options\" id=\"artifact-options\"></div></section><section class=\"pane pane-item\" id=\"item-rewards-section\" style=\"display:none\"><div class=\"pane-head\"><div class=\"pane-title\">可选：道具 <span id=\"item-selection-count\">3选1</span></div><div class=\"pane-sub\">已选 <span id=\"item-selected\">0</span>/<span id=\"item-max\">1</span></div></div><div class=\"options\" id=\"item-options\"></div></section></div><div class=\"reward-actions\"><button class=\"btn btn-plain\" id=\"later-btn\">稍后</button> <button class=\"btn btn-primary\" id=\"confirm-btn\" disabled=\"disabled\">确认领取</button></div></div></div><script>function t(t){return Array.isArray(t)?t.filter(t=>\"$__META_EXTENSIBLE__$\"!==t&&\"[]\"!==t&&null!=t&&\"\"!==t):[]}function e(t,e=null){return null==t?e:Array.isArray(t)&&t.length>0?t[0]:t}function n(t,e=[]){return Array.isArray(t)?t.length>=1&&Array.isArray(t[0])?t[0]:t:e}function a(t,e){const n=t?.[e];return Array.isArray(n)&&n.length>=1&&Array.isArray(n[0])?n[0]:Array.isArray(n)?n:(t[e]=[],t[e])}const s={cards:[],artifacts:[],items:[]};function r(e){return e?Array.isArray(e)&&e.length>=1&&Array.isArray(e[0])?t(e[0]):Array.isArray(e)?t(e):\"object\"==typeof e?[e]:[]:[]}let i={cards:1,artifacts:1,items:1};function c(...t){console.log(\"[Reward]\",...t)}function o(){try{return getCurrentMessageId()}catch(t){return\"latest\"}}function l(){const t=o();return\"latest\"===t?{type:\"message\"}:{type:\"message\",message_id:t}}function d(){try{const t=getVariables(l());return c(\"从消息获取变量数据@message_id=\",o(),t),t?{stat:t.stat_data||{},display:t.display_data||{}}:null}catch(t){return console.warn(\"从消息获取变量失败:\",t),null}}function u(a,s){const r=document.getElementById(\"changes-section\"),i=document.getElementById(\"changes-list\");if(!r||!i)return;const c=[],o=e(a?.status?.profession),l=s?.status?.profession;null!=o&&\"\"!==o&&(\"string\"==typeof l&&l.includes(\"->\")?c.push(`职业：${l}`):c.push(`职业：${o}`));t(n(a?.status?.permanent_status,[])).forEach(t=>c.push(`新增永久状态：${t}`));const d=e(a?.status?.clothing,{}),u=s?.status?.clothing||{};[\"head\",\"neck\",\"hands\",\"upper_body\",\"lower_body\",\"underwear\",\"undergarments\",\"legs\",\"feet\"].forEach(t=>{const n=e(d?.[t]);if(null==n||\"\"===n)return;const a=u?.[t];\"string\"==typeof a&&a.includes(\"->\")?c.push(`${t}：${a}`):c.push(`${t}：${n}`)});t(n(a?.status?.inventory,[])).forEach(t=>c.push(`新增持有物：${t}`));t(n(a?.battle?.cards,[])).forEach(t=>c.push(`新增卡牌：${(t?.emoji||\"🃏\")+\" \"+(t?.name||\"未知\")} ${t?.quantity?\"x\"+t.quantity:\"\"}`));t(n(a?.battle?.artifacts,[])).forEach(t=>c.push(\"新增遗物：\"+((t?.emoji||\"💎\")+\" \"+(t?.name||\"未知\"))));t(n(a?.battle?.items,[])).forEach(t=>c.push(`新增道具：${(t?.emoji||\"🧪\")+\" \"+(t?.name||\"未知\")}${t?.count?\" x\"+t.count:\"\"}`));const m=e(a?.battle?.player_lust_effect);if(m&&(m.name||m.description||m.effect)){const t=m.name?`“${m.name}”`:\"\";c.push(`玩家欲望效果：获得${t}`)}const p=e(a?.battle?.core?.card_removal_count),y=s?.battle?.core?.card_removal_count;null!=p&&(\"string\"==typeof y&&y.includes(\"->\")?c.push(`删卡次数：${y}`):c.push(`删卡次数：${p}`)),c.length>0?(r.style.display=\"\",i.innerHTML=c.map(t=>`<span class=\"pill\">${t}</span>`).join(\"\")):r.style.display=\"none\"}function m(t,e){const n=document.getElementById(\"level-exp-badge\"),a=document.getElementById(\"exp-section\"),s=document.getElementById(\"exp-display\");if(!n||!a||!s)return;const r=t?.battle?.level??1,i=t?.battle?.exp??0;n.textContent=`Lv.${r} · EXP ${i}`,n.style.display=\"\";const c=e?.battle?.exp,o=e?.battle?.level,l=[];\"string\"==typeof c&&c.includes(\"->\")&&l.push(`📈 经验变化：${c}`),\"string\"==typeof o&&o.includes(\"->\")&&l.push(`📊 等级变化：${o}`),l.length>0?(a.style.display=\"\",s.innerHTML=l.map(t=>`<div class=\"exp-item\"><span class=\"exp-icon\">✨</span><span class=\"exp-text\">${t}</span></div>`).join(\"\")):a.style.display=\"none\"}function p(t){const e=t?.reward;if(!e)return;i={cards:e.limits?.cards||1,artifacts:e.limits?.artifacts||1,items:e.limits?.items||1};const n=r(e.card),a=r(e.artifact),s=r(e.item);f({sectionId:\"card-rewards-section\",listId:\"card-options\",titleCountId:\"card-selection-count\",selectedId:\"card-selected\",maxId:\"card-max\",type:\"cards\",max:i.cards,options:n.map(t=>({icon:t.emoji||\"🃏\",title:`${t.name} · ${t.type||\"Skill\"} · ${t.rarity||\"Common\"}`,desc:t.description||\"无描述\"}))}),f({sectionId:\"artifact-rewards-section\",listId:\"artifact-options\",titleCountId:\"artifact-selection-count\",selectedId:\"artifact-selected\",maxId:\"artifact-max\",type:\"artifacts\",max:i.artifacts,options:a.map(t=>({icon:t.emoji||\"💎\",title:t.name,desc:t.description||\"无描述\"}))}),f({sectionId:\"item-rewards-section\",listId:\"item-options\",titleCountId:\"item-selection-count\",selectedId:\"item-selected\",maxId:\"item-max\",type:\"items\",max:i.items,options:s.map(t=>({icon:t.emoji||\"🧪\",title:t.name,desc:t.description||\"无描述\"}))})}function y(){const t=document.getElementById(\"confirm-btn\");if(!t)return;const e=d();if(!e?.stat?.reward)return void(t.disabled=!1);const n=e.stat.reward,a=r(n.card),i=r(n.artifact),c=r(n.item),o=a.length>0,l=i.length>0,u=c.length>0;let m=!0;o&&0===s.cards.length&&(m=!1),l&&0===s.artifacts.length&&(m=!1),u&&0===s.items.length&&(m=!1),t.disabled=!m}function f(t){const e=document.getElementById(t.sectionId),n=document.getElementById(t.listId),a=document.getElementById(t.titleCountId),r=document.getElementById(t.selectedId),i=document.getElementById(t.maxId);if(!e||!n)return;if(0===t.options.length)return void(e.style.display=\"none\");e.style.display=\"\",a&&(a.textContent=`${t.options.length}选${t.max}`),i&&(i.textContent=String(t.max));const c=1===t.max?\"radio\":\"checkbox\",o=1===t.max?`reward-${t.type}`:\"\";n.innerHTML=t.options.map((t,e)=>`\\n  <label class=\"option\">\\n    <input type=\"${c}\" ${o?`name=\"${o}\"`:\"\"} value=\"${e}\" />\\n    <span class=\"icon\">${t.icon}</span>\\n    <span class=\"text\">\\n      <div class=\"name\">${t.title}</div>\\n      <div class=\"desc\">${t.desc}</div>\\n    </span>\\n  </label>`).join(\"\");n.querySelectorAll(`input[type=\"${c}\"]`).forEach(e=>{e.addEventListener(\"change\",e=>{const n=e.target,a=s[t.type];if(1===t.max)n.checked&&(s[t.type]=[n.value]);else if(n.checked)a.length<t.max?a.push(n.value):(n.checked=!1,\"undefined\"!=typeof toastr&&toastr.warning(`最多只能选择${t.max}个`,\"选择限制\"));else{const t=a.indexOf(n.value);-1!==t&&a.splice(t,1)}r&&(r.textContent=String(s[t.type].length)),y()})})}function g(){const t=document.getElementById(\"later-btn\"),n=document.getElementById(\"confirm-btn\");t?.addEventListener(\"click\",()=>{const t=document.getElementById(\"reward-card\");t&&(t.style.display=\"none\")}),n?.addEventListener(\"click\",async()=>{try{await async function(){console.group(\"[奖励系统] 应用选择\"),console.log(\"选择：\",s);try{await updateVariablesWith(t=>{if(!t.stat_data)throw new Error(\"stat_data不存在\");const n=e(t.stat_data.reward);if(!n)throw new Error(\"reward数据不存在\");const i=r(n.card),c=r(n.artifact),o=r(n.item),l=t.stat_data.battle,d=Array.isArray(l),u=d?l[0]||={}:t.stat_data.battle||={};if(console.log(\"[奖励系统] 写入位置：\",d?\"battle[0]\":\"battle\"),s.cards.length>0){const t=a(u,\"cards\");s.cards.forEach(e=>{const n=parseInt(e),a=i[n];a&&t.push(a)})}if(s.artifacts.length>0){const t=a(u,\"artifacts\");s.artifacts.forEach(e=>{const n=parseInt(e),a=c[n];a&&t.push(a)})}if(s.items.length>0){const t=a(u,\"items\");s.items.forEach(e=>{const n=parseInt(e),a=o[n];a&&t.push(a)})}return d&&(t.stat_data.battle[0]=u),t},l())}finally{console.groupEnd()}}(),await async function(){console.group(\"[奖励系统] 清除临时奖励变量\");try{await updateVariablesWith(t=>{if(t.stat_data&&t.stat_data.reward)if(Array.isArray(t.stat_data.reward)&&t.stat_data.reward.length>=1){const e=t.stat_data.reward[0]||{};e.card=[],e.artifact=[],e.item=[],e.limits={},t.stat_data.reward[0]=e}else t.stat_data.reward.card=[],t.stat_data.reward.artifact=[],t.stat_data.reward.item=[],t.stat_data.reward.limits={};return t},l()),console.log(\"✅ 临时奖励变量清除完成\")}finally{console.groupEnd()}}();const t=document.getElementById(\"reward-card\");t&&(t.style.display=\"none\"),\"undefined\"!=typeof toastr&&toastr.success(\"奖励已成功领取！\",\"恭喜！\")}catch(t){console.error(\"确认奖励失败:\",t),\"undefined\"!=typeof toastr&&toastr.error(\"领取奖励失败，请重试\",\"错误\")}})}let h=!1,E=null,I=null,_=null,v=null;function w(){if(h)return;const t=()=>{c(\"事件触发 -> 刷新奖励页\"),function(){const t=getVariables(l()),e=t?.stat_data||{},n=t?.display_data||{};s.cards.length=0,s.artifacts.length=0,s.items.length=0;const a=t=>{const e=document.getElementById(t);e&&(e.innerHTML=\"\")};a(\"card-options\"),a(\"artifact-options\"),a(\"item-options\"),u(e,n),m(e,n),p(e),y()}()};E=e=>t(),I=e=>t(),_=e=>t(),v=e=>t(),eventOn(tavern_events.MESSAGE_UPDATED,E),eventOn(tavern_events.MESSAGE_RECEIVED,I),eventOn(tavern_events.GENERATION_ENDED,_),eventOn(tavern_events.MESSAGE_SWIPED,v),h=!0}$(()=>{!function(){const t=d();if(!t)return void c(\"无法获取变量数据\");const{stat:e,display:n}=t;s.cards.length=0,s.artifacts.length=0,s.items.length=0;const a=document.getElementById(\"reward-card\");a&&(a.style.display=\"block\"),u(e,n),m(e,n),p(e),y()}(),g(),w()}),$(window).on(\"unload\",()=>{try{E&&eventClearListener(E),I&&eventClearListener(I),_&&eventClearListener(_),v&&eventClearListener(v)}catch(t){console.warn(\"清理事件监听失败:\",t)}});</script></body></html>\n```",
    "trimStrings": [],
    "placement": [
        2
    ],
    "disabled": true,
    "markdownOnly": true,
    "promptOnly": false,
    "runOnEdit": false,
    "substituteRegex": 0,
    "minDepth": null,
    "maxDepth": null
}